<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gest√£o de Pend√™ncias ‚Äî Edel White</title>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

<style>
:root{
  --red:#E30613;
  --dark:#1E1E1E;
  --muted:#6B7280;
  --bg:#F6F7FB;
  --surface:#FFFFFF;
  --border:#E5E7EB;
  --shadow:0 12px 30px rgba(0,0,0,.08);
  --radius-lg:16px;
  --radius-md:12px;
  --radius-sm:8px;
}
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
}
body{
  font:15.5px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial;
  color:var(--dark);
  background:var(--bg);
}

/* ===== LAYOUT GERAL ===== */
.app{
  display:grid;
  grid-template-columns:300px 1fr;
  min-height:100vh;
}
.sidebar{
  background:linear-gradient(180deg,#fff,#FDF3F3);
  border-right:1px solid var(--border);
  padding:22px;
  display:flex;
  flex-direction:column;
  gap:16px;
  transition:.3s;
}
.brand{
  display:flex;
  align-items:flex-start;
  gap:12px;
}
.brand-logo{
  width:56px;
  height:56px;
  border-radius:15px;
  background:var(--red);
  box-shadow:var(--shadow);
  display:grid;
  place-items:center;
  padding:3px;
}
.brand-logo img{
  width:100%;
  height:100%;
  object-fit:contain;
  background:#fff;
  border-radius:10px;
  padding:1px;
}
.brand-name{
  display:flex;
  flex-direction:column;
}
.brand-name h1{
  font-size:18px;
  font-weight:800;
  line-height:1.2;
  color:#111827;
}
.brand-name .sub{
  font-size:12px;
  color:var(--muted);
  line-height:1.3;
}

/* Navega√ß√£o lateral */
.nav h2{
  font-size:12px;
  text-transform:uppercase;
  color:var(--muted);
  letter-spacing:.05em;
  margin:8px 0 6px;
}
.seg-btn{
  width:100%;
  background:#fff;
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:12px;
  text-align:left;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  transition:.2s;
  font-size:14px;
  font-weight:500;
}
.seg-btn:hover{
  transform:translateY(-2px);
  box-shadow:var(--shadow);
}
.seg-btn.active{
  border-color:var(--red);
  box-shadow:0 0 0 2px rgba(227,6,19,.2);
}
.chip{
  font-size:12px;
  color:#fff;
  background:var(--red);
  padding:2px 8px;
  border-radius:999px;
  min-width:20px;
  text-align:center;
  line-height:1.2;
}

.tools{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:auto;
}
.btn{
  border:none;
  border-radius:var(--radius-md);
  padding:10px 14px;
  font-weight:600;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:.15s;
  font-size:14px;
}
.btn.primary{
  background:var(--red);
  color:#fff;
}
.btn.primary:hover{
  filter:brightness(.95);
}
.btn.neutral{
  background:#fff;
  border:1px solid var(--border);
  color:var(--dark);
}

/* ===== MAIN / TOPBAR ===== */
.main{
  padding:22px;
}
.topbar{
  display:flex;
  align-items:flex-start;
  gap:10px;
  justify-content:space-between;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.page-title{
  font-size:26px;
  font-weight:800;
  line-height:1.2;
  color:#111827;
}
.kpi-line{
  font-size:13px;
  color:var(--muted);
}
.hamburger{
  display:none;
  background:none;
  border:none;
  font-size:28px;
  color:var(--red);
  cursor:pointer;
  line-height:1;
}

/* ===== BOARD / KANBAN ===== */
.board{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:14px;
  overflow-x:auto;
  padding-bottom:10px;
  scroll-snap-type:x mandatory;
}
.column{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:16px;
  min-width:320px;
  scroll-snap-align:start;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:12px;
}
.column h3{
  margin-bottom:4px;
  font-size:18px;
  font-weight:700;
  color:#111827;
}
.help{
  font-size:12px;
  color:var(--muted);
  margin-bottom:4px;
}
.dropzone{
  min-height:20px;
}

/* ===== CARD ===== */
.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:14px;
  box-shadow:var(--shadow);
  cursor:grab;
  display:flex;
  flex-direction:column;
  gap:12px;
  animation:cardFade .2s ease;
}

@keyframes cardFade{
  from{opacity:0;transform:translateY(4px);}
  to{opacity:1;transform:translateY(0);}
}

/* Header do card - t√≠tulo e metadados na mesma linha */
.card-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  flex-wrap:wrap;
}

.card-title{
  font-size:15px;
  font-weight:600;
  color:#111827;
  flex:1;
  min-width:200px;
}

.card-meta{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}

.priority-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  line-height:1;
  font-weight:600;
  border-radius:999px;
  padding:4px 8px;
  color:#fff;
  box-shadow:0 6px 16px rgba(0,0,0,.15);
  animation:fadeIn .25s ease;
  white-space:nowrap;
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(-2px) scale(.95);}
  to{opacity:1;transform:translateY(0) scale(1);}
}

/* prioridade cores */
.priority-alta{
  background:#E30613;
  box-shadow:0 6px 16px rgba(227,6,19,.4);
  color:#fff;
}
.priority-media{
  background:linear-gradient(90deg,#F59E0B 0%,#FBBF24 100%);
  color:#111;
  box-shadow:0 6px 16px rgba(251,191,36,.4);
}
.priority-baixa{
  background:linear-gradient(90deg,#22C55E 0%,#86EFAC 100%);
  color:#fff;
  box-shadow:0 6px 16px rgba(16,185,129,.4);
}

.badge-overdue{
  display:inline-block;
  font-size:11px;
  line-height:1;
  padding:4px 8px;
  border-radius:999px;
  background:var(--red);
  color:#fff;
  font-weight:600;
  box-shadow:0 6px 16px rgba(227,6,19,.4);
  white-space:nowrap;
}

/* infos abaixo do t√≠tulo */
.card-info{
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:13px;
  color:#4B5563;
  line-height:1.4;
  margin-top:4px;
}

/* a√ß√µes do card */
.card-actions {
  display: flex;
  justify-content: center; /* Centraliza horizontalmente */
  gap: 1px;
  margin-top: 6px;
}

.icon-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 1px;
  border: none;
  border-radius: var(--radius-sm);
  padding: 8px 12px;
  font-size: 13px;
  line-height: 1.2;
  cursor: pointer;
  transition: 0.15s ease;
  font-weight: 500;
  min-width: 90px; /* deixa todos com mesmo tamanho */
  text-align: center;
}

.icon-btn.edit{
  background: #4B5563;
  color:#fff;
}
.icon-btn.edit:hover{
  filter:brightness(.650);
}
.icon-btn.delete{
  background:#4B5563;
  color:#fff;
}
.icon-btn.delete:hover{
  background:#DC2626;
}
/* ===== Bot√£o de detalhes vis√≠vel e estilizado ===== */

.icon-btn.details-btn {
  background: #fff;
  border: 1px solid var(--border);
  color: #111827;
  box-shadow: 0 4px 10px rgba(0,0,0,.05);
  transition: 0.15s ease;
}
.icon-btn.details-btn:hover {
  background: #F3F4F6;
  transform: translateY(-1px);
}


/* Ajuste do container das a√ß√µes */
.card-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 8px;
}


/* painel de detalhes expandido */
.details{
  display:none;
  border-top:1px dashed var(--border);
  padding-top:12px;
}
.details.open{
  display:block;
}

/* grids dentro de detalhes */
.details-sections{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:16px;
  margin-bottom:16px;
}
.block{
  background:#fff;
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.04);
  font-size:13px;
  color:#1F2937;
}
.block h5{
  font-size:13px;
  font-weight:600;
  color:#111827;
  margin-bottom:8px;
  display:flex;
  align-items:center;
  gap:6px;
}
.block-row{
  font-size:13px;
  line-height:1.4;
  margin-bottom:6px;
  word-break:break-word;
}
.block-row-label{
  font-weight:600;
  color:#374151;
}

/* Coment√°rios e hist√≥rico */
.inline-form{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:12px 0;
}
.inline-form input{
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  padding:8px;
  font-size:13px;
  flex:1 1 auto;
  min-width:130px;
}
.inline-form input:focus{
  outline:2px solid rgba(227,6,19,.25);
  box-shadow:0 0 0 3px rgba(227,6,19,.12);
}
.comment,
.history{
  font-size:13px;
  color:#4B5563;
  line-height:1.4;
  margin-bottom:4px;
}
.help{
  font-size:12px;
  color:var(--muted);
  margin-bottom:4px;
}

/* ===== OVERVIEW ===== */
.overview{
  display:none;
}
.overview.active{
  display:block;
}
.widgets{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:12px;
  margin-top:8px;
}
.widget{
  background:#fff;
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:12px;
  box-shadow:var(--shadow);
}
.widget h4{
  margin:0 0 8px;
  font-size:14px;
  font-weight:600;
  color:#1F2937;
}
.widget-value{
  font-size:28px;
  font-weight:800;
  color:#111827;
}
.widget-value.red{
  color:var(--red);
}
.canvas-wrap{
  width:100%;
  height:240px;
}
canvas{
  width:100%;
  height:240px;
  border:1px dashed #F1F5F9;
  border-radius:var(--radius-md);
  background:#fff;
}

/* ===== MODAL ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  align-items:center;
  justify-content:center;
  padding:10px;
  z-index:1000;
}
.modal.open{
  display:flex;
}
.sheet{
  width:min(860px,96vw);
  max-height:92vh;
  overflow:auto;
  background:#fff;
  border-radius:var(--radius-lg);
  padding:20px 22px;
  box-shadow:var(--shadow);
}
.sheet h3{
  font-size:20px;
  font-weight:800;
  margin-bottom:10px;
  color:#111827;
}
.grid-form{
  display:grid;
  grid-template-columns:repeat(12,1fr);
  gap:12px;
}
.field{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.field.full{grid-column:1/-1;}
.field.col-6{grid-column:span 6;}
.field label{
  font-size:12px;
  color:var(--muted);
  font-weight:600;
}
.field input,
.field textarea,
.field select{
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:11px 12px;
  font:inherit;
  background:#fff;
  font-size:14px;
}
.field textarea{
  min-height:84px;
  resize:vertical;
}
.field input:focus,
.field textarea:focus,
.field select:focus{
  outline:2px solid rgba(227,6,19,.25);
  box-shadow:0 0 0 3px rgba(227,6,19,.12);
}
.req-hint{
  font-size:12px;
  color:var(--muted);
  line-height:1.4;
}
.err{
  font-size:12px;
  color:#DC2626;
}

.actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
  margin-top:16px;
}
.actions .btn{
  min-width:120px;
}
#btnDelete{
  background:#4B5563;
  color:#fff;
}
#btnDelete:hover{
  background:#DC2626;
}

/* ===== RESPONSIVO ===== */
@media (max-width:1024px){
  .app{grid-template-columns:260px 1fr;}
}
@media (max-width:900px){
  .app{grid-template-columns:1fr;}
  .sidebar{
    position:fixed;
    left:-100%;
    top:0;
    height:100vh;
    width:280px;
    z-index:999;
  }
  .sidebar.open{
    left:0;
  }
  .hamburger{
    display:block;
  }
  .grid-form{
    grid-template-columns:1fr;
  }
  .field.col-6{
    grid-column:1/-1;
  }
}
</style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-logo">
        <img src="img/65a1ed2e380e6.png" alt="Logo Edel White">
      </div>
      <div class="brand-name">
        <h1>Trello Edel White</h1>
        <div class="sub">Pend√™ncias por Setor</div>
      </div>
    </div>

    <nav class="nav">
      <h2>SETORES</h2>
      <div id="navSetores"></div>

      <div class="tools">
        <button class="btn primary" id="btnNew">+ Novo</button>
        <button class="btn neutral" id="btnOverview">Vis√£o Geral</button>
      </div>
    </nav>
  </aside>

  <!-- CONTE√öDO PRINCIPAL -->
  <main class="main">
    <div class="topbar">
      <button class="hamburger" id="btnMenu">‚ò∞</button>
      <div class="page-title" id="pageTitle">SAC</div>
      <div class="kpi-line" id="kpiLine">‚Äî</div>
    </div>

    <!-- Kanban -->
    <section class="board" id="board"></section>

    <!-- Painel de vis√£o geral -->
    <section class="overview" id="overview">
      <div class="widgets" id="widgets"></div>

      <div class="widgets">
        <div class="widget">
          <h4>Abertos vs Conclu√≠dos por setor</h4>
          <div class="canvas-wrap">
            <canvas id="cvBars"></canvas>
          </div>
        </div>

        <div class="widget">
          <h4>Prazo vencido (SLA)</h4>
          <div class="canvas-wrap">
            <canvas id="cvPie"></canvas>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="sheet">
    <h3 id="modalTitle">Novo Ticket</h3>
    <form id="formTicket">
      <div class="grid-form">
        <div class="field full">
          <label>T√≠tulo*</label>
          <input id="iTitle" required />
          <div class="err" id="eTitle"></div>
        </div>

        <div class="field col-6">
          <label>Setor*</label>
          <select id="iSector" required></select>
          <div class="err" id="eSector"></div>
        </div>

        <div class="field col-6">
          <label>Status*</label>
          <select id="iStatus" required>
            <option>Aberto</option>
            <option>Em andamento</option>
            <option>Aguardando</option>
            <option>Conclu√≠do</option>
          </select>
        </div>

        <div class="field col-6">
          <label>Prioridade</label>
          <select id="iPriority">
            <option value="low">Baixa</option>
            <option value="medium" selected>M√©dia</option>
            <option value="high">Alta</option>
          </select>
        </div>

        <div class="field col-6">
          <label>Prazo</label>
          <input id="iDue" type="date" />
        </div>

        <div class="field col-6">
          <label>N¬∫ da nota (opcional)</label>
          <input id="iInvoice" />
        </div>

        <div class="field full">
          <label>Descri√ß√£o</label>
          <textarea id="iDesc" rows="3"></textarea>
        </div>

        <div class="field full">
          <label>Campos do setor</label>
          <div class="req-hint" id="sectorHelp">Adaptado ao setor selecionado.</div>
          <div id="sectorFields"></div>
          <div class="err" id="eSectorFields"></div>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn neutral" id="btnClose">Cancelar</button>
        <button type="button" class="btn" id="btnDelete">Excluir</button>
        <button type="submit" class="btn primary" id="btnSave">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ======================
   FIREBASE CONFIG
====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAzZABnsXbMcYDYIXCg3hxBy53c3cBaJNQ",
  authDomain: "manager-edel-white.firebaseapp.com",
  projectId: "manager-edel-white",
  storageBucket: "manager-edel-white.firebasestorage.app",
  messagingSenderId: "928454260867",
  appId: "1:928454260867:web:61a2f5106fcaffe41d43b6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ======================
   CONSTANTES
====================== */
const SECTORS = ["SAC","Log√≠stica","Comercial","Faturamento","Financeiro"];
const STATUSES = ["Aberto","Em andamento","Aguardando","Conclu√≠do"];

let currentSector = "SAC";
let overviewMode = false;
let dragRef = null; // usado no drag & drop

/* ======================
   INICIALIZA√á√ÉO
====================== */
initUI();
loadSector(currentSector);

function initUI(){
  // sidebar setores
  const nav = document.getElementById("navSetores");
  nav.innerHTML = "";
  SECTORS.forEach(s=>{
    const b = document.createElement("button");
    b.className = "seg-btn";
    b.innerHTML = `<span>${s}</span><span class="chip" id="chip-${s}">0</span>`;
    b.onclick = () => {
      overviewMode = false;
      toggleOverview(false);
      switchSector(s);
    };
    nav.appendChild(b);
  });

  // menu mobile
  document.getElementById("btnMenu").onclick = () => {
    document.getElementById("sidebar").classList.toggle("open");
  };

  // novo ticket
  document.getElementById("btnNew").onclick = () => openModal();

  // vis√£o geral
  document.getElementById("btnOverview").onclick = async () => {
    overviewMode = !overviewMode;
    toggleOverview(overviewMode);
    if (overviewMode) {
      await renderOverview();
    }
  };

  // form modal
  document.getElementById("iSector").innerHTML = SECTORS.map(s=>`<option>${s}</option>`).join("");
  document.getElementById("iSector").value = currentSector;
  document.getElementById("iSector").addEventListener("change", renderSectorFields);

  renderSectorFields(); // campos espec√≠ficos do setor atual

  document.getElementById("btnClose").onclick = closeModal;
  document.getElementById("btnDelete").onclick = delFromModal;
  document.getElementById("formTicket").addEventListener("submit", saveTicket);
}

function toggleOverview(on){
  document.getElementById("overview").classList.toggle("active", on);
  document.getElementById("board").style.display = on ? "none" : "grid";
  document.getElementById("pageTitle").textContent = on ? "Vis√£o Geral" : currentSector;
}

function switchSector(s){
  currentSector = s;
  document.getElementById("pageTitle").textContent = s;
  loadSector(s);
}

/* ======================
   CARREGAR SETOR / BOARD
====================== */
async function loadSector(sector){
  const snap = await db.collection("tickets").where("sector","==",sector).get();

  const grouped = {};
  STATUSES.forEach(st=>grouped[st]=[]);
  snap.forEach(doc=>{
    const d = doc.data();
    grouped[d.status] = grouped[d.status] || [];
    grouped[d.status].push({id:doc.id, ...d});
  });

  renderBoard(grouped);
  updateSidebarBadges();
  updateKPIline(snap.docs.map(d=>d.data()));
}

/* Render das colunas do Kanban */
function renderBoard(grouped){
  const board = document.getElementById("board");
  board.innerHTML = "";

  STATUSES.forEach(st=>{
    const col = document.createElement("section");
    col.className = "column";
    col.innerHTML = `
      <h3>${st}</h3>
      <div class="help">${
        st === "Aberto"
          ? "Novo/triagem"
          : st === "Em andamento"
          ? "Execu√ß√£o"
          : st === "Aguardando"
          ? "Depend√™ncia/aprova√ß√£o"
          : "Finalizado"
      }</div>
      <div class="dropzone" data-status="${st}"
        ondragover="event.preventDefault()"
        ondrop="onDrop(event)"></div>
    `;

    // adiciona cards
    (grouped[st]||[]).forEach(ticket=>{
      col.querySelector(".dropzone").appendChild(ticketCard(ticket));
    });

    board.appendChild(col);
  });
}

/* ======================
   CARD DO TICKET
====================== */
function ticketCard(t){
  const el = document.createElement("article");
  el.className = "card";
  el.id = t.id;
  el.draggable = true;

  el.addEventListener("dragstart", () => { 
    dragRef = {id: t.id, from: t.status}; 
  });

  const dueDate = t.dueDate ? new Date(t.dueDate) : null;
  const overdue = !!(dueDate && (Date.now() - dueDate.getTime() > 86400000));

  const priorityLabel = getPriorityLabel(t.priority);
  const priorityClass = getPriorityClass(t.priority);

  el.innerHTML = `
    <div class="card-header">
      <div class="card-title">${escapeHtml(t.title || "")}</div>
      <div class="card-meta">
        <span class="priority-pill ${priorityClass}">
          ${priorityLabel}
        </span>
        ${overdue ? `<span class="badge-overdue">Prazo estourado</span>` : ""}
      </div>
    </div>

    <div class="card-info">
      ${t.invoiceNumber ? `<div>Nota: ${escapeHtml(t.invoiceNumber)}</div>` : ""}
      ${t.dueDate ? `<div>Prazo: ${formatDateBR(t.dueDate)}</div>` : ""}
    </div>

    <div class="card-actions">
      <button class="icon-btn edit" onclick='openModal(${JSON.stringify(t)})'>‚úèÔ∏è Editar</button>
      <button class="icon-btn delete" onclick='deleteTicket("${t.id}")'>üóëÔ∏è Excluir</button>
      <button class="icon-btn details-btn" onclick='toggleDetails("${t.id}")'>üîç Detalhes</button>
    </div>

    <div class="details" id="details-${t.id}">
      <div class="details-sections">
        <div class="block">
          <h5>Informa√ß√µes do ticket</h5>
          <div class="block-row"><span class="block-row-label">T√≠tulo:</span> ${escapeHtml(t.title||"-")}</div>
          <div class="block-row"><span class="block-row-label">Setor:</span> ${escapeHtml(t.sector||"-")}</div>
          <div class="block-row"><span class="block-row-label">Status:</span> ${escapeHtml(t.status||"-")}</div>
          <div class="block-row"><span class="block-row-label">Prioridade:</span> ${priorityLabel}</div>
          <div class="block-row"><span class="block-row-label">Prazo:</span> ${t.dueDate?formatDateBR(t.dueDate):"-"}</div>
          <div class="block-row"><span class="block-row-label">Nota:</span> ${t.invoiceNumber||"-"}</div>
          <div class="block-row"><span class="block-row-label">Descri√ß√£o:</span> ${escapeHtml(t.description||"-")}</div>
        </div>
        <div class="block">
          <h5>Campos do setor</h5>
          ${renderExtraBlock(t)}
        </div>
      </div>

      <div class="block">
        <h5>Coment√°rios</h5>
        <div class="inline-form">
          <input id="author-${t.id}" placeholder="Seu nome">
          <input id="cmt-${t.id}" placeholder="Novo coment√°rio">
          <button class="btn primary" style="padding:8px 12px;font-size:13px" onclick='addComment("${t.id}")'>Adicionar</button>
        </div>
        <div id="comments-${t.id}" class="comments-list"></div>
      </div>

      <div class="block">
        <h5>Hist√≥rico de status</h5>
        <div id="history-${t.id}" class="history-list"></div>
      </div>
    </div>
  `;
  return el;
}


/* Renderiza os campos extras (por setor) dentro do detalhe */
function renderExtraBlock(t){
  const extra = t.extra || {};
  const s = t.sector || "";

  if(s === "SAC"){
    return `
      <div class="block-row"><span class="block-row-label">Data do ocorrido:</span> ${extra.sx_dataOcorrido || "-"}</div>
      <div class="block-row"><span class="block-row-label">Informa√ß√µes do ocorrido:</span> ${escapeHtml(extra.sx_infoOcorrido || "-")}</div>
    `;
  }
  if(s === "Faturamento"){
    return `
      <div class="block-row"><span class="block-row-label">Pedidos a faturar:</span> ${escapeHtml(extra.ft_pedidos || "-")}</div>
    `;
  }
  if(s === "Log√≠stica"){
    return `
      <div class="block-row"><span class="block-row-label">Itens em falta:</span> ${escapeHtml(extra.lg_itensFalta || "-")}</div>
      <div class="block-row"><span class="block-row-label">Previs√£o importa√ß√£o:</span> ${extra.lg_previsao || "-"}</div>
      <div class="block-row"><span class="block-row-label">Pend√™ncias:</span> ${escapeHtml(extra.lg_pendencias || "-")}</div>
    `;
  }
  if(s === "Comercial"){
    return `
      <div class="block-row"><span class="block-row-label">Pedidos pendentes:</span> ${escapeHtml(extra.cm_pedidos || "-")}</div>
      <div class="block-row"><span class="block-row-label">Itens em falta:</span> ${escapeHtml(extra.cm_itensFalta || "-")}</div>
      <div class="block-row"><span class="block-row-label">Previs√£o de entrega:</span> ${extra.cm_previsao || "-"}</div>
    `;
  }
  if(s === "Financeiro"){
    return `
      <div class="block-row"><span class="block-row-label">Checagem de boleto:</span> ${escapeHtml(extra.fn_boletos || "-")}</div>
      <div class="block-row"><span class="block-row-label">Entregas:</span> ${escapeHtml(extra.fn_entregas || "-")}</div>
      <div class="block-row"><span class="block-row-label">SAC relacionados:</span> ${escapeHtml(extra.fn_sac || "-")}</div>
    `;
  }
  return `<div class="block-row">Nenhum campo espec√≠fico.</div>`;
}

/* Prioridade -> texto e classe visual */
function getPriorityLabel(p){
  if(p === "high") return "Alta";
  if(p === "medium") return "M√©dia";
  if(p === "low") return "Baixa";
  return p || "-";
}
function getPriorityClass(p){
  if(p === "high") return "priority-alta";
  if(p === "medium") return "priority-media";
  if(p === "low") return "priority-baixa";
  return "";
}

/* ======================
   DRAG & DROP
====================== */
async function onDrop(e){
  e.preventDefault();
  const to = e.currentTarget.dataset.status;
  const d = dragRef;
  if(!d || !d.id || d.from === to) return;

  // salva direto no Firestore e registra hist√≥rico
  await db.collection("tickets").doc(d.id).update({
    status: to,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await db.collection("tickets").doc(d.id)
    .collection("history")
    .add({
      status: to,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

  loadSector(currentSector);
}
window.onDrop = onDrop;

/* ======================
   DETALHES (coment√°rios + hist√≥rico)
====================== */
async function toggleDetails(id){
  const box = document.getElementById("details-"+id);
  box.classList.toggle("open");

  if(box.classList.contains("open")){
    await loadComments(id);
    await loadHistory(id);
  }
}

async function loadComments(id){
  const list = document.getElementById("comments-"+id);
  list.innerHTML = '<div class="help">Carregando coment√°rios...</div>';

  const snap = await db.collection("tickets").doc(id)
    .collection("comments")
    .orderBy("timestamp","desc")
    .get();

  if(snap.empty){
    list.innerHTML = '<div class="help">Sem coment√°rios.</div>';
    return;
  }

  list.innerHTML = "";
  snap.forEach(c=>{
    const d = c.data();
    const when = d.timestamp?.toDate?.();
    const line = document.createElement("div");
    line.className = "comment";
    line.textContent = `${d.author||"Usu√°rio"} ‚Äî ${formatDateTimeBR(when)}: ${d.text}`;
    list.appendChild(line);
  });
}

async function addComment(id){
  const authorEl = document.getElementById("author-"+id);
  const input = document.getElementById("cmt-"+id);

  const author = (authorEl?.value || "").trim();
  const text = (input?.value || "").trim();
  if(!text){
    alert("Digite um coment√°rio.");
    return;
  }

  await db.collection("tickets").doc(id)
    .collection("comments")
    .add({
      author: author || "Usu√°rio",
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

  if(input) input.value = "";
  await loadComments(id);
}

async function loadHistory(id){
  const list = document.getElementById("history-"+id);
  list.innerHTML = '<div class="help">Carregando hist√≥rico...</div>';

  const snap = await db.collection("tickets").doc(id)
    .collection("history")
    .orderBy("timestamp","desc")
    .get();

  if(snap.empty){
    list.innerHTML = '<div class="help">Sem hist√≥rico.</div>';
    return;
  }

  list.innerHTML = "";
  snap.forEach(h=>{
    const d = h.data();
    const when = d.timestamp?.toDate?.();
    const line = document.createElement("div");
    line.className = "history";
    line.textContent = `${formatDateTimeBR(when)} ‚Äî Status: ${d.status}`;
    list.appendChild(line);
  });
}

/* ======================
   BADGES LATERAIS + KPI
====================== */
async function updateSidebarBadges(){
  for(const s of SECTORS){
    const n = (await db.collection("tickets").where("sector","==",s).get()).size;
    const chip = document.getElementById("chip-"+s);
    if(chip) chip.textContent = n;
  }
}

function updateKPIline(items){
  const tot = items.length;
  const a   = items.filter(i=>i.status==="Aberto").length;
  const c   = items.filter(i=>i.status==="Conclu√≠do").length;
  const ov  = items.filter(i=> i.dueDate && (Date.now()-new Date(i.dueDate).getTime()>86400000)).length;

  document.getElementById("kpiLine").textContent =
    `${tot} tickets ‚Äî Abertos: ${a} ‚Ä¢ Conclu√≠dos: ${c} ‚Ä¢ Vencidos: ${ov}`;
}

/* ======================
   OVERVIEW (gr√°ficos sem libs externas)
====================== */
async function renderOverview(){
  const widgets = document.getElementById("widgets");
  widgets.innerHTML = "";

  const all = await db.collection("tickets").get();
  const data = all.docs.map(d => ({id:d.id,...d.data()}));

  const total = data.length;
  const ab = data.filter(x=>x.status==="Aberto").length;
  const co = data.filter(x=>x.status==="Conclu√≠do").length;
  const venc = data.filter(x=>x.dueDate && (Date.now()-new Date(x.dueDate).getTime()>86400000)).length;

  widgets.appendChild(kpiWidget("Total", total));
  widgets.appendChild(kpiWidget("Abertos", ab));
  widgets.appendChild(kpiWidget("Conclu√≠dos", co));
  widgets.appendChild(kpiWidget("Vencidos (SLA)", venc, true));

  const perSector = SECTORS.map(s=>({
    s,
    a: data.filter(x=>x.sector===s && x.status==="Aberto").length,
    c: data.filter(x=>x.sector===s && x.status==="Conclu√≠do").length
  }));

  drawBars(document.getElementById("cvBars"), perSector);
  drawPie(
    document.getElementById("cvPie"),
    [venc, total - venc],
    ["Vencidos","No prazo"]
  );
}

function kpiWidget(label,val,red){
  const el = document.createElement("div");
  el.className = "widget";
  el.innerHTML = `
    <h4>${label}</h4>
    <div class="widget-value ${red ? "red" : ""}">${val}</div>
  `;
  return el;
}

/* ===== Barras: abertos X conclu√≠dos por setor ===== */
function drawBars(cv, rows){
  const ctx = cv.getContext("2d");
  const w = cv.width = cv.clientWidth * 2;
  const h = cv.height = cv.clientHeight * 2;

  ctx.clearRect(0,0,w,h);

  const pad = 80;
  const max = Math.max(1, ...rows.map(r=>Math.max(r.a,r.c)));
  const bw = (w-2*pad)/(rows.length*3);
  let x = pad;

  ctx.font = "28px Inter";

  rows.forEach(r=>{
    const ha = (r.a/max)*(h-2*pad);
    ctx.fillStyle = "#FCA5A5"; // abertos
    ctx.fillRect(x, h-pad-ha, bw, ha);
    x += bw;

    const hc = (r.c/max)*(h-2*pad);
    ctx.fillStyle = "#86EFAC"; // conclu√≠dos
    ctx.fillRect(x, h-pad-hc, bw, hc);
    x += bw;

    ctx.fillStyle = "#334155";
    ctx.fillText(r.s, x-bw, h-pad+32);
    x += bw;
  });

  ctx.strokeStyle = "#CBD5E1";
  ctx.beginPath();
  ctx.moveTo(pad,h-pad);
  ctx.lineTo(w-pad,h-pad);
  ctx.stroke();
}

/* ===== Pizza: prazos vencidos ===== */
function drawPie(cv, values, labels){
  const ctx = cv.getContext("2d");
  const w = cv.width = cv.clientWidth * 2;
  const h = cv.height = cv.clientHeight * 2;

  ctx.clearRect(0,0,w,h);

  const total = values.reduce((a,b)=>a+b,0)||1;
  const cx = w/2;
  const cy = h/2;
  const r = Math.min(w,h)/3;
  let ang = -Math.PI/2;

  const colors = ["#E30613","#93C5FD"];

  ctx.font = "28px Inter";
  for(let i=0;i<values.length;i++){
    const slice = (values[i]/total)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,ang,ang+slice);
    ctx.closePath();
    ctx.fillStyle = colors[i%colors.length];
    ctx.fill();

    const pct = Math.round(values[i]/total*100);
    ctx.fillStyle = "#334155";
    ctx.fillText(`${labels[i]}: ${pct}%`, 40, 60+34*i);

    ang += slice;
  }
}

/* ======================
   MODAL / FORM
====================== */
const form = document.getElementById("formTicket");

function openModal(pref){
  document.getElementById("modalTitle").textContent = pref ? "Editar Ticket" : "Novo Ticket";
  form.dataset.editing = pref ? pref.id : "";
  form.dataset.prevStatus = pref ? (pref.status || "Aberto") : "";

  fillForm(pref);
  document.getElementById("modal").classList.add("open");
}

function closeModal(){
  document.getElementById("modal").classList.remove("open");
  form.reset();
  form.dataset.editing = "";
  form.dataset.prevStatus = "";
  clearErrors();
  document.getElementById("iSector").value = currentSector;
  renderSectorFields();
}

function fillForm(d={}){
  document.getElementById("iTitle").value   = d?.title        || "";
  document.getElementById("iSector").value  = d?.sector       || currentSector;
  document.getElementById("iStatus").value  = d?.status       || "Aberto";
  document.getElementById("iPriority").value= d?.priority     || "medium";
  document.getElementById("iDesc").value    = d?.description  || "";
  document.getElementById("iDue").value     = d?.dueDate      || "";
  document.getElementById("iInvoice").value = d?.invoiceNumber|| "";

  renderSectorFields(d?.extra || {});
}

/* Campos adicionais por setor */
function renderSectorFields(prefill={}){
  const s = document.getElementById("iSector").value;
  const box = document.getElementById("sectorFields");
  const help = document.getElementById("sectorHelp");
  let html = "";

  if(s === "SAC"){
    help.textContent = "SAC: Data do ocorrido* e Informa√ß√µes do ocorrido*";
    html = `
      <div class="field col-6" style="margin-bottom:8px">
        <label>Data do ocorrido*</label>
        <input id="sx_dataOcorrido" type="date" required>
      </div>
      <div class="field col-6" style="margin-bottom:8px">
        <label>Informa√ß√µes do ocorrido*</label>
        <textarea id="sx_infoOcorrido" rows="2" required></textarea>
      </div>
    `;
  }
  else if(s === "Faturamento"){
    help.textContent = "Faturamento: Pedidos a faturar*";
    html = `
      <div class="field full">
        <label>Pedidos a faturar*</label>
        <textarea id="ft_pedidos" rows="2" required></textarea>
      </div>
    `;
  }
  else if(s === "Log√≠stica"){
    help.textContent = "Log√≠stica: Itens em falta, Previs√£o de importa√ß√£o, Pend√™ncias";
    html = `
      <div class="field full">
        <label>Itens em falta</label>
        <textarea id="lg_itensFalta" rows="2"></textarea>
      </div>
      <div class="field col-6">
        <label>Previs√£o importa√ß√£o</label>
        <input id="lg_previsao" type="date">
      </div>
      <div class="field full">
        <label>Pend√™ncias</label>
        <textarea id="lg_pendencias" rows="2"></textarea>
      </div>
    `;
  }
  else if(s === "Comercial"){
    help.textContent = "Comercial: Pedidos pendentes, Itens em falta, Previs√£o de entrega";
    html = `
      <div class="field full">
        <label>Pedidos pendentes</label>
        <textarea id="cm_pedidos" rows="2"></textarea>
      </div>
      <div class="field full">
        <label>Itens em falta</label>
        <textarea id="cm_itensFalta" rows="2"></textarea>
      </div>
      <div class="field col-6">
        <label>Previs√£o de entrega</label>
        <input id="cm_previsao" type="date">
      </div>
    `;
  }
  else if(s === "Financeiro"){
    help.textContent = "Financeiro: Checagem de boleto, Entregas, SAC relacionados";
    html = `
      <div class="field full">
        <label>Checagem de boleto</label>
        <textarea id="fn_boletos" rows="2"></textarea>
      </div>
      <div class="field full">
        <label>Entregas</label>
        <textarea id="fn_entregas" rows="2"></textarea>
      </div>
      <div class="field full">
        <label>SAC relacionados</label>
        <textarea id="fn_sac" rows="2"></textarea>
      </div>
    `;
  } else {
    help.textContent = "Sem campos espec√≠ficos para este setor.";
  }

  box.innerHTML = html;

  // preencher valores se veio de edi√ß√£o
  for(const [k,v] of Object.entries(prefill)){
    const el = document.getElementById(k);
    if(el) el.value = v;
  }
}

function collectExtras(){
  const ids = [
    "sx_dataOcorrido","sx_infoOcorrido",
    "ft_pedidos",
    "lg_itensFalta","lg_previsao","lg_pendencias",
    "cm_pedidos","cm_itensFalta","cm_previsao",
    "fn_boletos","fn_entregas","fn_sac"
  ];
  const obj = {};
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) obj[id] = el.value;
  });
  return obj;
}

function clearErrors(){
  ["eTitle","eSector","eSectorFields"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.textContent = "";
  });
}

/* SALVAR / EXCLUIR */
async function saveTicket(e){
  e.preventDefault();
  clearErrors();

  const editingId  = form.dataset.editing || "";
  const prevStatus = form.dataset.prevStatus || "";

  const title         = document.getElementById("iTitle").value.trim();
  const sector        = document.getElementById("iSector").value;
  const status        = document.getElementById("iStatus").value;
  const priority      = document.getElementById("iPriority").value;
  const description   = document.getElementById("iDesc").value.trim();
  const dueDate       = document.getElementById("iDue").value;
  const invoiceNumber = document.getElementById("iInvoice").value.trim();
  const extra         = collectExtras();

  if(!title){
    document.getElementById("eTitle").textContent = "Informe um t√≠tulo";
    return;
  }
  if(!sector){
    document.getElementById("eSector").textContent = "Selecione um setor";
    return;
  }
  if(sector === "SAC"){
    if(!extra.sx_dataOcorrido || !extra.sx_infoOcorrido){
      document.getElementById("eSectorFields").textContent =
        "Preencha Data e Informa√ß√µes do ocorrido.";
      return;
    }
  }
  if(sector === "Faturamento"){
    if(!extra.ft_pedidos){
      document.getElementById("eSectorFields").textContent =
        "Preencha \"Pedidos a faturar\".";
      return;
    }
  }

  const payload = {
    title,
    sector,
    status,
    priority,
    description,
    dueDate,
    invoiceNumber,
    extra,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    if(editingId){
      // update
      await db.collection("tickets").doc(editingId).update(payload);

      // se mudou status, gravar hist√≥rico
      if(prevStatus && prevStatus !== status){
        await db.collection("tickets").doc(editingId)
          .collection("history")
          .add({
            status,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
      }

    } else {
      // create
      payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      const ref = await db.collection("tickets").add(payload);

      // hist√≥rico inicial
      await db.collection("tickets").doc(ref.id)
        .collection("history")
        .add({
          status,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    closeModal();
    loadSector(currentSector);
    if(overviewMode){ renderOverview(); }

  } catch(err){
    alert("Erro ao salvar: "+err.message);
  }
}

async function delFromModal(){
  const id = form.dataset.editing || "";
  if(!id) return;
  if(!confirm("Excluir este ticket?")) return;

  await db.collection("tickets").doc(id).delete();

  closeModal();
  loadSector(currentSector);
  if(overviewMode){ renderOverview(); }
}

async function deleteTicket(id){
  if(!confirm("Excluir este ticket?")) return;
  await db.collection("tickets").doc(id).delete();
  loadSector(currentSector);
  if(overviewMode){ renderOverview(); }
}

/* ======================
   FUN√á√ïES AUXILIARES
====================== */
function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g, m=>({
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    "\"":"&quot;",
    "'":"&#39;"
  }[m]));
}
function two(n){return (n<10?"0":"")+n}
function formatDateBR(ymd){
  if(!ymd) return "";
  const [y,m,d] = ymd.split("-");
  return `${d}/${m}/${y}`;
}
function formatDateTimeBR(date){
  if(!date) return "-";
  const dd=two(date.getDate());
  const mm=two(date.getMonth()+1);
  const yyyy=date.getFullYear();
  const hh=two(date.getHours());
  const min=two(date.getMinutes());
  return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
}

/* ======================
   FIRESTORE RULES (lembrete)
====================== */
/*
No console do Firebase > Firestore > Regras, coloque isso enquanto estiver testando sem login:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /tickets/{ticketId} {
      allow read, write: if true;
      match /comments/{commentId} { allow read, write: if true; }
      match /history/{historyId} { allow read, write: if true; }
    }
  }
}

Depois a gente pode restringir por setor ou por rede interna.
*/
</script>
</body>
</html>
